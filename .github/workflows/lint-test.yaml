name: Lint Test

on: 
  pull_request:
    paths-ignore:
      - '.github/**'
      - 'README.md'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-test:
    env:
      branch_name: ${{ github.head_ref || github.ref_name }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout ğŸ›ï¸
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
      with:
        fetch-depth: 0

    - name: Setup Helm ğŸ§°
      uses: azure/setup-helm@5119fcb9089d432beecbf79bb2c7915207344b78 # v3
      with:
        version: v3.13.0

    - name: Setup Python ğŸ
      uses: actions/setup-python@65d7f2d534ac1bc67fcd62888c5f4f3d2cb2b236 # v4
      with:
        python-version: 3.11

    - name: Setup chart-testing ğŸ§°
      uses: helm/chart-testing-action@e6669bcd63d7cb57cb4380c33043eebe5d111992 # v2.6.1

    - name: Setup pybump
      if: ${{ contains(env.branch_name, 'renovate') }}
      run: |
        pip3 install pybump

    - name: Bump chart version
      if: ${{ contains(env.branch_name, 'renovate') }}
      id: bumped_charts
      run: |
        .github/renovate-bump.sh

    - name: Run Chart lint tests ğŸ§ª
      run: ct lint

    # Use the REST API to commit changes, so we get automatic commit signing
    - name: Push changes
      if: ${{ contains(env.branch_name, 'renovate') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        changed_charts: ${{ steps.bumped_charts.outputs.CHARTS }}
      run: |
        for chart in ${changed_charts}; do
          export SHA=$(git rev-parse origin/${branch_name}:${chart} )

          gh api --method PUT /repos/:owner/:repo/contents/${chart} \
            --field message="chore: bumped ${chart} version" \
            --field content=@<( base64 -i ${chart} ) \
            --field branch="${branch_name}" \
            --field sha="$SHA"
        done
